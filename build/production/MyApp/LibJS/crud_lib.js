var f_crud={cerrar_mensaje:function(a){Ext.Function.defer(function(){Ext.Msg.hide()},a*1000)},mensaje:function(b,a,c){Ext.Msg.show({title:b,width:"80%",message:a,iconCls:"x-fa fa-warning",buttons:Ext.Msg.OK,fn:function(d){f_crud.enviar_msg_error(b+", "+a)}})},enviar_msg_error:function(a){if(MyApp.main.estado==="on"){Ext.Ajax.request({url:MyApp.url_lib+"js_error_log.php",params:{mensaje:a},success:function(b){console.log("Mensaje enviado OK.")},failure:function(b,c){console.log("Falla en envio de mensaje!")}})}},load_mysql_store:function(b,d,k){var j=Ext.getStore(b);var e=Ext.create(j.getProxy().getModel().getName());var h="";var f=e.getFields();for(var c=0;c<f.length;c++){h=h+f[c].getName()+","}h=h.substring(0,h.length-1);var g=j.getProxy();g.setUrl(MyApp.url_lib+"crud_lib.php");var a=g.getReader().getRootProperty();g.setExtraParam("base_url",MyApp.base_url);g.setExtraParam("base_nombre",MyApp.base_nombre);g.setExtraParam("base_usuario",MyApp.base_usuario);g.setExtraParam("base_clave",MyApp.base_clave);g.setExtraParam("sql_table",a);g.setExtraParam("sql_fields",h+" ");if(d){if(d.length>1){g.setExtraParam("sql_command",d)}}j.load(function(m,l,n){if(!n){f_crud.mensaje("Error 1 de lectura en tabla: "+a,"Controle su conexi√≥n a Internet.");if(typeof k=="function"){k(-1)}}if(n&&m!=null&&m!==undefined){console.log("Table: "+a+'" records: '+m.length);if(m.length===0){console.log("Sql:",d)}if(typeof k=="function"){k(j)}}else{f_crud.mensaje("Error de Base de Datos","Controle el nombre de la Base de Datos y/o la url del Servidor.");if(typeof k=="function"){k(-1)}}})},save_mysql_array:function(c,b){var a="";a='{"records":'+JSON.stringify(c)+"}";console.log(a);Ext.Ajax.request({url:MyApp.url_lib+"crud_lib.php?action=batch",params:{data:a,base_url:MyApp.base_url,base_nombre:MyApp.base_nombre,base_usuario:MyApp.base_usuario,base_clave:MyApp.base_clave},success:function(d){var e=Ext.JSON.decode(d.responseText,true);if(!e){console.log(d.responseText);if(typeof b=="function"){b(1)}}if(e.success){console.log("dentro success.");if(typeof b=="function"){b(1)}}else{f_crud.mensaje("Error SQL","Se cancelara la sincronizacion <br> Debugging: "+e.message,5);console.log(e.message+" -<br>"+a);if(typeof b=="function"){b(-1)}}},failure:function(d,e){console.log("Response text: "+d.responseText+" Respuesta n: "+d.status);console.log("While trying to send to: "+MyApp.url_lib+"crud_lib.php?action=batch");f_crud.mensaje("Error","Revise su conexion Internet. Ocurrio un error al intentar conectarse al servidor",5);if(typeof b=="function"){b(-1)}}})},secuencia_mysql:function(a,b){if(!a){var a=0}Ext.Ajax.request({url:MyApp.url_lib+"crud_lib.php?action=secuencia",params:{cant:a,base_url:MyApp.base_url,base_nombre:MyApp.base_nombre,base_usuario:MyApp.base_usuario,base_clave:MyApp.base_clave},success:function(c){var d=Ext.JSON.decode(c.responseText,true);if(d.secuencia>0){if(typeof b=="function"){b(d.secuencia)}}else{f_crud.mensaje("Error al obtener secuencia",c.responseText,5);if(typeof b=="function"){b(-1)}}},failure:function(c,d){console.log("server-side failure with status code "+c.status);if(typeof b=="function"){b(-1)}}})},sql_command:function(e,f){var b=openDatabase(MyApp.archivo_base,"1.0",MyApp.archivo_base,5*1024*1024);var c=[];b.transaction(function(g){g.executeSql(e)},d,a);function a(){console.log("db.transaction = Ok ",e);if(typeof f=="function"){f(1)}}function d(g){console.log("db.transaction = Fail! ",e);if(typeof f=="function"){f(-1)}}},sql_commands:function(a,g){var d=openDatabase(MyApp.archivo_base,"1.0",MyApp.archivo_base,5*1024*1024);var e=[];var c="";d.transaction(function(h){for(var k in a){c=a[k];h.executeSql(a[k])}},f,b);function b(){console.log("db.transaction = Ok - last sql = ",c);if(typeof g=="function"){g(1)}}function f(h){console.log("db.transaction = Fail! ",sql);if(typeof g=="function"){g(-1)}}},sql_select:function(e,f){var b=openDatabase(MyApp.archivo_base,"1.0",MyApp.archivo_base,5*1024*1024);var c=[];b.transaction(function(g){g.executeSql(e,[],function(h,k){for(var j=0;j<k.rows.length;j++){c.push(k.rows.item(j))}})},d,a);function a(){if(typeof f=="function"){f(c)}}function d(){console.log("db.transaction = Fail! ",e);if(typeof f=="function"){f(-1)}}},load_store:function(b,h,e,p){var n=Ext.getStore(b),f=Ext.create(n.getProxy().getModel().getName()),m="",j=f.getFields();for(var d=0;d<j.length;d++){m=m+j[d].getName()+","}m=m.substring(0,m.length-1);var k=n.getProxy().getModel().getName();var a=k.slice(k.lastIndexOf(".")+1);var l=n.getProxy();var q=openDatabase(MyApp.archivo_base,"1.0",MyApp.archivo_base,5*1024*1024);var r=" Select "+m+" from "+a;if(e&&e.length>1){r=e}if(h&&h.length>1){r=r+" where "+h}var g=[];n.getProxy().clear();n.data.clear();n.sync();q.transaction(function(s){s.executeSql(r,[],function(t,v){for(var u=0;u<v.rows.length;u++){g.push(v.rows.item(u))}n.add(g)})},c,o);function o(){console.log("db.transaction = Ok - "+a+" count: "+n.getCount());if(typeof p=="function"){p(n)}}function c(){console.log("db.transaction = Fail! ",r);f_crud.create_table(a);if(typeof p=="function"){p(n)}}},openNestedForm:function(b){var a=Ext.create("MyApp.view."+b);a.fake=true;a.fireEvent("render",a);f_crud.form_open(a,"ADD");a.close();a.destroy()},form_open:function(b,g){var e=Ext.create(b.form_name),f,a=function(j,k,h){if(k.keyCode===13){k.stopEvent();j.blur()}};if(g==="EDIT"&&typeof b.record==="undefined"){return}MyApp.pantalla_anterior=MyApp.main.getLayout().getActiveItem();if(e.getForm){frmFields=e.getForm().getFields().items;for(var c=frmFields.length-1;c>=0;c--){frmFields[c].enableKeyEvents=true;frmFields[c].addListener("keypress",a)}}if(b.parent){e.parent=b.parent}e.model_name=b.model_name;e.store_name=b.store_name;e.store_array=b.form_store_array;e.grid_panel=b.down("#grid");e.action=g;if(g==="ADD"){var d=Ext.create(e.model_name);f_crud.secuencia(function(h){if(h!==-1){d.set("id",h);e.loadRecord(d);if(typeof d.get("codigo")==="undefined"){MyApp.main.add(e);MyApp.main.getLayout().setActiveItem(e)}else{f_crud.get_codigo(d,function(j){d.set("codigo",j);e.loadRecord(d);MyApp.main.add(e);MyApp.main.getLayout().setActiveItem(e)})}}})}else{if(g==="EDIT"){e.loadRecord(b.record)}MyApp.main.add(e);MyApp.main.getLayout().setActiveItem(e)}},grid_check_delete:function(c,b){var e=true,g=[],a="",l="",f,h,k=openDatabase(MyApp.archivo_base,"1.0",MyApp.archivo_base,5*1024*1024),j=[];if(!Array.isArray(b)){b=[b]}a="SELECT name FROM sqlite_master WHERE type='table' AND (";for(var d=b.length-1;d>=0;d--){a=a+"name = '"+b[d].table+"'";if(d>0){a=a+" OR "}}a=a+")";k.transaction(function(m){m.executeSql(a,[],function(o,n){for(var p=n.rows.length-1;p>=0;p--){j.push(n.rows[p].name)}})},function(m){console.log("db.transaction = Fail! - sql statement: "+m.message)},function(){if(j.length>0){for(var m=b.length-1;m>=0;m--){f=b[m];if(j.indexOf(f.table)>-1){if(!f.pkName){h="codigo"}else{h=f.pkName}l=l+"select count(*) as 'Count', '"+f.table+"' as 'Table' from "+f.table+" where "+f.field+"="+c.record.data[h];g.push("delete from "+f.table+" where "+f.field+"="+c.record.data[h]);if(m>0){l=l+" union "}}}k.transaction(function(n){n.executeSql(l,[],function(p,o){for(var q=o.rows.length-1;q>=0;q--){if(o.rows[q].Count>0){e=false}}})},function(n){console.log("db.transaction = Fail! - sql statement: "+n.message)},function(){if(e){f_crud.grid_delete(c)}else{Ext.Msg.show({title:b[0].msgTitle,message:b[0].message,iconCls:"x-fa fa-warning",buttons:Ext.Msg.OK})}})}else{f_crud.grid_delete(c)}})},grid_delete:function(b,c){var a=function(f){var d=Ext.getStore(b.store_name);if(f=="yes"){b.form_store_array[0].remove(b.record);if(b.form_store_array.length>1){for(var e=1;e<b.form_store_array.length;e++){d=b.form_store_array[e];console.log("store",d);d.each(function(j,g,h){console.log("dentro each");d.remove(j)})}}f_crud.save_stores(b.form_store_array)}};if(c){a("yes")}else{Ext.Msg.show({title:"Borrar registro",message:"Desea borrar el registro",buttons:Ext.Msg.YESNO,buttonText:{yes:"Si",no:"No"},iconCls:"x-fa fa-warning",fn:a})}},close_form:function(b){var a=function(c){if(c==="yes"){if(MyApp.main.getLayout().getLayoutItems().length>1){MyApp.main.getLayout().prev()}b.close();var d=window.localStorage.getItem("estado_sinc");if(d==="Pendiente"){MyApp.main.down("#estado_sinc").setHtml("Sincronizado: "+d);window.localStorage.setItem("estado_sinc","Pendiente")}}};if(!b.saved&&b.isDirty&&b.isDirty()){Ext.Msg.show({title:"Cancelar la carga?",message:"Perdera toda los datos agregados<br> en este formulario",buttons:Ext.Msg.YESNO,buttonText:{yes:"Si, salir",no:"Permanecer"},iconCls:"x-fa fa-warning",fn:a})}else{a("yes")}},save_several_records:function(g,f){var e=g.down("#addinggrid").getSelection(),b=g.store_array,a=e.length,c=b[0].getModel().getName(),d=c.slice(c.lastIndexOf(".")+1);f_crud.secuencia(function(h){if(h>-1){f_crud.get_codigos(d,a,function(l){if(l>-1){var o,k={},n=h,j=l,p;for(var m=a-1;m>=0;m--){p=e[m];o=Ext.create(g.model_name);o.set("id",n);o.set("codigo",j);k[f.gridRecordPK]=p.data.codigo;k[f.pivotPK]=g.parent.codigo;k.nombre=p.data.nombre+"("+g.parent.nombre+")";o.set(k);b[0].add(o);n--;j--}f_crud.save_stores(b,function(q){if(q>-1){g.saved=true;f_crud.close_form(g);console.log("Worked ok!")}else{reject("Error: while trying to save record")}})}else{reject("Error: while trying to generate codigo value")}})}else{reject("Error: while trying to generate id value")}},a)},save_form:function(k){var g=k.store_array,e=k.getRecord(),l=k.getValues(),c=/^(3[0-1]|[1-2][0-9]|0[1-9])\-(1[0-2]|0[1-9])\-(\d{4})$/i,m=/^(\d{4})\-(1[0-2]|0[1-9])\-(3[0-1]|[1-2][0-9]|0[1-9])$/i;e.set(l);for(property in l){var a=String(l[property]).match(c);if(a){var d=a[3]+"-"+a[2]+"-"+a[1],b={};b[property]=d;e.set(b)}}if(k.action==="ADD"){g[0].add(e);if(k.grid_panel.viewConfig){k.grid_panel.getSelectionModel().select(e)}else{if(MyApp.pantalla_anterior.initialCls==="formpanel"&&MyApp.pantalla_anterior.dropdownId){var f=MyApp.pantalla_anterior.dropdownId;var j=MyApp.pantalla_anterior.down("#"+f);j.setValue(k.getValues().codigo)}}}f_crud.save_stores(g,function(o){if(o===-1){alert("Error durante la grabaci√≥n ")}else{var n,p;for(i in g){n=g[i].getProxy().getModel().getName();p=n.slice(n.lastIndexOf(".")+1)}}});k.saved=true;f_crud.close_form(k);var h=window.localStorage.getItem("estado_sinc");if(h!=="Pendiente"){window.localStorage.setItem("estado_sinc","Pendiente");MyApp.main.down("#estado_sinc").setHtml("Sincronizado: Pendiente")}},save_stores:function(h,k,e){var c="",b="";var g=[];for(var d in h){f_crud.get_sql_commands(h[d],g,e)}var l=openDatabase(MyApp.archivo_base,"1.0",MyApp.archivo_base,5*1024*1024);var f="";l.transaction(function(m){for(var n in g){f=g[n];m.executeSql(g[n])}},a,j);function j(){console.log("db.transaction = Ok");for(var o in h){var n=h[o].data.items;for(var m=n.length-1;m>=0;m--){n[m].phantom=false}h[o].sync()}if(typeof k=="function"){k(1)}}function a(m){console.log("error",m.message);f_crud.mensaje("db.transaction = Fail!","Error: "+m.message+" Orden SQL:"+f);if(typeof k=="function"){k(-1)}}},get_sql_commands:function(p,m,l){var h,c,g,q="",e="",k=p.getProxy().getModel().getName(),a;a=k.slice(k.lastIndexOf(".")+1);var d=p.getUpdatedRecords();q="";for(var f in d){h=d[f];if(l!=="bajar"){if(h.get("estado_registro")!=="A"){h.set("estado_registro","M")}}if(l==="subir"&&h.aliasSQL){a=h.aliasSQL}q="Update "+a+" set ";var j=h.getFields();var o="";for(var f=0;f<j.length;f++){o=j[f];c=o.getName();g=c;if(o.aliasSQL&&l==="subir"){g=o.aliasSQL}if(o.sincronizar===false){c=null}if(h.get(c)){if(c==="estado_registro"&&l==="subir"){}else{if(o.getType()==="date"){q=q+g+" = '"+Ext.Date.format(h.get(c),"Y-m-d")+"', "}else{if(o.getType()==="int"||o.getType()==="float"){q=q+g+" = "+h.get(c)+", "}else{q=q+g+" = '"+h.get(c)+"', "}}}}}q=q.substr(0,q.length-2)+" where id="+h.get("id");if(l=="subir"){if(h.where){q=q+" and "+h.where}}m.push(q)}d=p.getNewRecords();q="";var n="";var b="";for(f in d){h=d[f];if(l!=="bajar"){h.set("estado_registro","A")}if(l==="subir"&&h.aliasSQL){a=h.aliasSQL;console.log("sql_table",a)}q="Insert into "+a+" ";n="(";b="(";var j=h.getFields();var o="";for(var f=0;f<j.length;f++){o=j[f];c=o.getName();g=c;if(l==="subir"){if(o.aliasSQL){g=o.aliasSQL}if(o.sincronizar===false){c=null}}if(h.get(c)){if(c==="estado_registro"&&l==="subir"){}else{n=n+g+",";if(o.getType()==="date"){b=b+"'"+Ext.Date.format(h.get(c),"Y-m-d")+"',"}else{if(o.getType()==="int"||o.getType()==="float"){b=b+h.get(c)+","}else{b=b+"'"+h.get(c)+"',"}}}}}n=n.substr(0,n.length-1)+")";b=b.substr(0,b.length-1)+")";q=q+n+" values "+b;m.push(q)}d=p.getRemovedRecords();q="";for(f in d){h=d[f];if(l==="subir"&&h.aliasSQL){a=h.aliasSQL}q="Delete from "+a+" where id="+h.get("id");if(h.get("estado_registro")!=="A"){e="Insert into Registros_borrados (id_registro,tabla) Values ("+h.get("id")+",'"+a+"')";m.push(e)}m.push(q)}return m},get_codigo:function(c,h){var b=c.self.getName(),a,e=openDatabase(MyApp.archivo_base,"1.0",MyApp.archivo_base,2*1024*1024),g;a=b.slice(b.lastIndexOf(".")+1);g="SELECT max(codigo) as codigo FROM "+a;e.transaction(function(j){j.executeSql(g,[],function(k,l){var m=Number(l.rows.item(0).codigo)+1;if(typeof h=="function"){h(m)}})},f,d);function d(){}function f(){f_crud.mensaje("Error","Se produjo un error al generar el nuevo C√≥digo - SQL:"+g)}},get_codigos:function(e,c,h){var d,g,b=openDatabase(MyApp.archivo_base,"1.0",MyApp.archivo_base,2*1024*1024);var g="SELECT max(codigo) as codigo FROM "+e;b.transaction(function(j){j.executeSql(g,[],function(k,l){if(c){d=Number(l.rows.item(0).codigo)+c}else{d=Number(l.rows.item(0).codigo)+1}if(typeof h==="function"){h(d)}})},f,a);function a(){}function f(){f_crud.mensaje("Error","Se produjo un error al generar el nuevo C√≥digo - SQL:"+g)}},get_max_id:function(c){var b=c.self.getName();var a=b.slice(b.lastIndexOf(".")+1);var e=openDatabase(MyApp.archivo_base,"1.0",MyApp.archivo_base,2*1024*1024);var g="SELECT max(id) as id FROM "+a;e.transaction(function(h){h.executeSql(g,[],function(j,k){var l=Number(k.rows.item(0).id)+1;c.set({id:l})})},f,d);function d(){}function f(){f_crud.mensaje("Error","Se produjo un error al generar el nuevo ID - SQL:"+g)}},checkSecuencia:function(){var b="select count(id) as cant from secuencia";var a=this;a.load_store("Secuencia","","",function(c){a.sql_select(b,function(e){var d=e[0].cant;if(d===0){a.sql_command("Insert into secuencia (id,secuencia) values (1,1)",function(f){console.log("Insert en tabla secuencia = ",f)})}})})},secuencia:function(f,e){if(!e){var e=0}var h=openDatabase(MyApp.archivo_base,"1.0",MyApp.archivo_base,2*1024*1024);var j="Update secuencia Set secuencia = secuencia +1 +"+e;var d;h.transaction(function(k){k.executeSql(j)},c,a);function c(){console.log("fail update");f_crud.create_table("Secuencia",function(k){if(k===1){j="Insert Into Secuencia (id,secuencia) Values (1,1) ";h.transaction(function(l){l.executeSql(j)},b,a)}})}function a(){j="SELECT max(secuencia) as id FROM secuencia";h.transaction(function(k){k.executeSql(j,[],function(l,m){d=Number(m.rows.item(0).id)+1})},b,g)}function g(){if(typeof f=="function"){f(d)}}function b(){console.log("f_fail");if(typeof f=="function"){f(-1)}f_crud.mensaje("Error Secuencia","Se produjo un error al generar el nuevo ID - SQL:"+j)}},drop_table:function(a){var b=openDatabase(MyApp.archivo_base,"1.0",MyApp.archivo_base,2*1024*1024);b.transaction(function(c){c.executeSql("drop table "+a);console.log("Drop table: "+a)})},truncate_table:function(b,a){var c=openDatabase(MyApp.archivo_base,"1.0",MyApp.archivo_base,2*1024*1024);c.transaction(function(d){d.executeSql("delete from "+b);console.log("Delete complete: "+b);if(a){a(b)}})},clean_all_tables:function(){var a=function(d){if(d==="yes"){var c,e=[];f_sinc.agregar_todas();c=MyApp.sinc_array_tabla;MyApp.sinc_array_tabla=[];for(var b=c.length-1;b>=0;b--){f_crud.truncate_table(c[b],function(f){f_crud.load_store(f,"1 = 0")})}e.push("Secuencia");e.push("sqlite_sequence");e.push("Registros_borrados");for(var b=e.length-1;b>=1;b--){f_crud.truncate_table(e[b])}f_crud.truncate_table(e[0]);MyApp.main.down("#estado_sinc").setHtml("Sincronizando: Pendiente");window.localStorage.setItem("estado_sinc","Pendiente");Ext.Msg.show({title:"Borrado completo",width:"80%",message:"Se ha borrado el contenido<br> de la BD local",iconCls:"x-fa fa-warning",buttons:Ext.Msg.OK,fn:function(f){console.log("Borrado todo");var g,h=MyApp.main.getLayout();h.setActiveItem(0);g=h.getNext();while(g){g.close();g.destroy();g=h.getNext()}}})}};Ext.Msg.show({title:"Borrar Todo",message:"Se borraran todos los registros<br> de la DB local, continuar?",iconCls:"x-fa fa-warning",buttons:Ext.Msg.YESNO,buttonText:{yes:"Si",no:"No"},fn:a})},create_table:function(b,j){var g=Ext.getStore(b);console.log("store",g);var e=g.getModel().getProxy();var d=g.getProxy().getModel().getName();var a=d.slice(d.lastIndexOf(".")+1);var f="CREATE TABLE IF NOT EXISTS "+a+" ("+f_crud.getSchemaString(e,g.getModel())+")";console.log("sql_create",f);var k=openDatabase(MyApp.archivo_base,"1.0",MyApp.archivo_base,5*1024*1024);k.transaction(function(l){l.executeSql(f)},c,h);function h(){console.log("Create table = Ok");if(typeof j=="function"){j(1)}}function c(){console.log("db.transaction = Fail! ",f);if(typeof j=="function"){j(-1)}}},getSchemaString:function(h,d){var k=h,b=[],m="uid",f=d.getFields().items,e=false,g=f.length,c,l,j,a;for(c=0;c<g;c++){l=f[c];j=l.getType();a=l.getName();if(a===m){if(e){j=f_crud.convertToSqlType(j);b.unshift(m+" "+j)}else{b.unshift(m+" INTEGER PRIMARY KEY AUTOINCREMENT")}}else{j=f_crud.convertToSqlType(j);b.push(a+" "+j)}}return b.join(", ")},convertToSqlType:function(a){switch(a.toLowerCase()){case"date":case"string":case"auto":return"TEXT";case"int":return"INTEGER";case"float":return"REAL";case"bool":return"NUMERIC"}},applyRenderer:function(c,b,e,g,a){var f,h=c.down("#"+b).columns,d=function(n,k,j,o,m,l){return f_crud.getDisplayValue(e,n,g)};for(f=h.length-1;f>=0;f--){if(h[f].dataIndex===a){h[f].renderer=d}}},getDisplayValue:function(d,f,g,b){var c=Ext.getStore(d),a,e;if(b){a=c.find(b,f)}else{a=c.find("codigo",f)}if(a>-1){e=c.getAt(a).get(g)}else{e=""}return e},renderGridWidth:function(a){var e=a.getColumns(),c=0,d=0;for(var b=e.length-1;b>=0;b--){if(e[b].hidden===false){c++}}if(c>0){d=100/c;avgStr=d+"%";for(b=e.length-1;b>=0;b--){if(e[b].hidden===false){e[b].width=avgStr}}}else{console.log("Error: all the columns were hidden!")}},setFormTitle:function(b,a){var c=b.initialTitle;if(b.action==="ADD"){if(a){b.setTitle("Nueva "+c)}else{b.setTitle("Nuevo "+c)}}else{if(b.action==="EDIT"){b.setTitle("Editar "+c)}else{b.setTitle(c)}}}};