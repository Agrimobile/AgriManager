f_sinc={agregar_todas:function(){MyApp.sinc_array_store[0]="ActividadesMysql";MyApp.sinc_array_tabla[0]="Actividades";MyApp.sinc_array_store[1]="CampaniasMysql";MyApp.sinc_array_tabla[1]="Campanias";MyApp.sinc_array_store[2]="ContratistasMysql";MyApp.sinc_array_tabla[2]="Contratistas";MyApp.sinc_array_store[3]="DepositosMysql";MyApp.sinc_array_tabla[3]="Depositos";MyApp.sinc_array_store[4]="EstablecimientosMysql";MyApp.sinc_array_tabla[4]="Establecimientos";MyApp.sinc_array_store[5]="InsumosMysql";MyApp.sinc_array_tabla[5]="Insumos";MyApp.sinc_array_store[6]="LaboresMysql";MyApp.sinc_array_tabla[6]="Labores";MyApp.sinc_array_store[7]="Labores_insumosMysql";MyApp.sinc_array_tabla[7]="Labores_insumos";MyApp.sinc_array_store[8]="Labores_maquinariaMysql";MyApp.sinc_array_tabla[8]="Labores_maquinaria";MyApp.sinc_array_store[9]="Labores_personalMysql";MyApp.sinc_array_tabla[9]="Labores_personal";MyApp.sinc_array_store[10]="LotesMysql";MyApp.sinc_array_tabla[10]="Lotes";MyApp.sinc_array_store[11]="Lotes_actividadesMysql";MyApp.sinc_array_tabla[11]="Lotes_actividades";MyApp.sinc_array_store[12]="Lotes_coordenadasMysql";MyApp.sinc_array_tabla[12]="Lotes_coordenadas";MyApp.sinc_array_store[13]="MaquinariaMysql";MyApp.sinc_array_tabla[13]="Maquinaria";MyApp.sinc_array_store[14]="PersonalMysql";MyApp.sinc_array_tabla[14]="Personal";MyApp.sinc_array_store[15]="RubrosMysql";MyApp.sinc_array_tabla[15]="Rubros";MyApp.sinc_array_store[16]="TareasMysql";MyApp.sinc_array_tabla[16]="Tareas"},sincronizar:function(c){var e=0;f_crud.checkSecuencia();function b(i,h){if(c){c.down("#tabla").setValue(h+" ("+e+"/"+MyApp.sinc_array_store.length+")")}else{MyApp.main.down("#estado_sinc").setHtml("Sincronizando: "+h);window.localStorage.setItem("estado_sinc","Pendiente")}f_sinc.sincronizar_upload(h,h,function(j){if(j===-1){Ext.Function.defer(function(){a()},3000);MyApp.main.down("#estado_sinc").setHtml("Sincronizado: Error!");window.localStorage.setItem("estado_sinc","Pendiente - Error");d();if(!c){f_sinc.defer_sinc()}return}console.log("Fin Upload",h);if(j!==-1){f_sinc.sincronizar_download(i,h,function(k){if(k===-1){Ext.Function.defer(function(){a()},3000);MyApp.main.down("#estado_sinc").setHtml("Sincronizado: Error!");window.localStorage.setItem("estado_sinc","Pendiente - Error");d();if(!c){f_sinc.defer_sinc()}return}console.log("Fin Download",h);e++;g()})}})}function g(){if(e===MyApp.sinc_array_store.length){if(c){c.down("#tabla").setValue("SINC. TERMINADA.")}d();if(c){Ext.Function.defer(function(){a()},2000)}MyApp.main.down("#estado_sinc").setHtml("Sincronizado: terminado");window.localStorage.setItem("estado_sinc","Terminado");MyApp.sinc_array_store=[];MyApp.sinc_array_tabla=[];f_crud.secuencia_mysql(1,function(h){f_crud.sql_command("Update secuencia set secuencia = "+h,function(i){console.log("Update secuencia set secuencia="+h,i)})});return}b(MyApp.sinc_array_store[e],MyApp.sinc_array_tabla[e])}function f(){for(var h in MyApp.sinc_array_tabla){f_crud.create_table(MyApp.sinc_array_tabla[h])}}function d(){for(var h in MyApp.sinc_array_tabla){console.log(MyApp.sinc_array_tabla[h]);f_crud.load_store(MyApp.sinc_array_tabla[h])}}function a(){var h=MyApp.main.getLayout();if(h.getPrev()){h.prev()}}f();g()},agregar_tabla:function(a){if(MyApp.sinc_array_tabla.indexOf(a)===-1){MyApp.sinc_array_store.push(a+"Mysql");MyApp.sinc_array_tabla.push(a)}},defer_sinc:function(){return;Ext.Function.defer(function(){if(MyApp.main.estado==="on"&&MyApp.main.down("#estado_editar").getHtml()===""){f_sinc.sincronizar()}else{f_sinc.defer_sinc()}},30000)},sincronizar_upload:function(g,f,e){var c="estado_registro = 'A' or estado_registro='M' ",b=[],d=[],a=0;f_crud.load_store(g,c,"",function(h){if(h===-1){console.log("Error subiendo");f_crud.mensaje("Error en Load sinc tabla:",f);if(typeof e=="function"){e(-1)}return}if(typeof h==="object"){console.log("Sincronizando upload tabla: "+g,h.getCount());h.each(function(l,j,k){if(l.get("estado_registro")==="A"){l.phantom=true;a++}else{l.set("estado_registro","E")}});if(a>0){f_crud.secuencia_mysql(a,function(k){if(k===-1){if(typeof e=="function"){e(-1)}}var j=k-a;h.each(function(n,l,m){if(n.get("estado_registro")==="A"){if(f==="Labores"){d.push("Update Labores_insumos    set id_labores="+j+" where id_labores="+n.get("id"));d.push("Update Labores_personal   set id_labores="+j+" where id_labores="+n.get("id"));d.push("Update Labores_maquinaria set id_labores="+j+" where id_labores="+n.get("id"))}n.set("id",j);j++}});i()})}else{i()}function i(){f_crud.get_sql_commands(h,b,"subir");f_crud.load_store("Registros_borrados","Upper(tabla)='"+f.toUpperCase()+"'","",function(l){if(l===-1){console.log("Error subiendo");f_crud.mensaje("Error:","Error de lectura de registros borrados.",5);if(typeof e=="function"){e(-1)}return}var k=f;var j=Ext.create(h.getProxy().getModel().getName());if(j.getInitialConfig("sql_alias")){k=j.getInitialConfig("sql_alias")}l.each(function(o,m,n){b.push("Delete from "+k+" where id="+o.get("id_registro"))});f_crud.save_mysql_array(b,function(m){if(m===-1){if(typeof e=="function"){e(-1)}return}console.log("dentro rtn",m);f_crud.sql_command("Update "+f+" set estado_registro=null");f_crud.sql_command("Delete from Registros_borrados where Upper(tabla)='"+f.toUpperCase()+"'");if(f==="Labores"){f_crud.sql_commands(d,function(n){console.log("update id_labores... =",n)})}if(typeof e=="function"){e(1)}})})}}})},sincronizar_download:function(d,c,b){var a=Ext.getStore(d);if(!a){f_crud.mensaje("Error","No existe el datastore: "+d+", o no tiene definida una orden SQL",5);if(typeof b=="function"){b(-1)}return}f_crud.load_mysql_store(d,a.getSql(),function(e){if(e===-1){console.log("Error de descarga");if(typeof b=="function"){b(-1)}return}if(typeof e==="object"){if(e.getCount()>0){f_crud.sql_command("Delete from "+c,function(f){if(f===1){e.each(function(i,g,h){i.phantom=true});f_crud.save_stores([e],function(g){if(g===-1){console.log("Error al sincronizar tabla:",c);if(typeof b=="function"){b(g)}}e.each(function(j,h,i){j.phantom=false});if(typeof b=="function"){b(g)}},"bajar")}})}else{if(typeof b=="function"){b(1)}}}})},};